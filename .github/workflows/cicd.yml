name: CI/CD Workflow

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  PACKAGE_REGISTRY_TO_USE: thmork
  DOCKER_IMAGE_NAME: mfps
  PROJECT_NAME: MFPS
  GROUP_NUMBER: Group09

jobs:
  clone-repository:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upload Repository artifacts
        uses: actions/upload-artifact@v4
        with:
          name: repository-artifacts
          path: .

  code-analysis:
    runs-on: ubuntu-latest
    needs: clone-repository
    permissions:
      contents: read
    continue-on-error: true
    steps:
      - name: Download repository artifact
        uses: actions/download-artifact@v4
        with:
          name: repository-artifacts
          path: .

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y
          echo "install your-linting-dependencies"

      - name: Run Linter / Other Code Analysis tool
        run: echo "running linter"

  build-application:
    runs-on: ubuntu-latest
    needs: clone-repository
    steps:
      - name: Download repository artifact
        uses: actions/download-artifact@v4
        with:
          name: repository-artifacts
          path: .

      - name: Build application
        run: echo "build app"

      - name: Upload Build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: ./src

  test-application:
    runs-on: ubuntu-latest
    needs: [build-application, code-analysis]
    continue-on-error: true
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: ./build

      - name: Test application
        run: echo "test"

  # âœ… Build & push BOTH images (backend + dashboard) like docker-compose does
  build-push-docker-images:
    runs-on: ubuntu-latest
    needs: [test-application]
    permissions:
      packages: write
      contents: read
    steps:
      - name: Download repository artifact
        uses: actions/download-artifact@v4
        with:
          name: repository-artifacts
          path: .

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Transform owner to lowercase
        run: echo "OWNER_LOWER=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ---- BACKEND ----
      - name: Build & Push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./src/backend
          file: ./src/backend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LOWER }}/${{ env.DOCKER_IMAGE_NAME }}-backend:1.0-${{ github.sha }}
            ghcr.io/${{ env.OWNER_LOWER }}/${{ env.DOCKER_IMAGE_NAME }}-backend:latest

      # ---- DASHBOARD ----
      - name: Build & Push dashboard image
        uses: docker/build-push-action@v6
        with:
          context: ./src/dashboard
          file: ./src/dashboard/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LOWER }}/${{ env.DOCKER_IMAGE_NAME }}-dashboard:1.0-${{ github.sha }}
            ghcr.io/${{ env.OWNER_LOWER }}/${{ env.DOCKER_IMAGE_NAME }}-dashboard:latest

  deploy-application:
    runs-on: ubuntu-latest
    needs: [build-push-docker-images]
    continue-on-error: true
    steps:
      - name: Logic for deploying application
        run: echo "deploy app"
